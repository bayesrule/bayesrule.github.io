var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,i,s;e=e||{},t=void 0!==e.parent?e.parent:document.body,i=void 0!==e.id?e.id:"oldie",s=Detector.getWebGLErrorMessage(),s.id=i,t.appendChild(s)}};!function(e,t,i,s,n,o){function a(t,i){this.element=t,this.options=e.extend({},h,i),this._defaults=h,this._name=r,this.init()}var r="Valiant360",h={crossOrigin:"anonymous",clickAndDrag:!1,fov:35,fovMin:3,fovMax:100,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,debug:!1,flatProjection:!1,autoplay:!0,disableZoom:!1};a.prototype={init:function(){this._time=(new Date).getTime(),this._controls={},this._id=this.generateUUID(),this._requestAnimationId="",this._isVideo=!1,this._isPhoto=!1,this._isFullscreen=!1,this._mouseDown=!1,this._dragStart={},this._lat=this.options.lat,this._lon=this.options.lon,this._fov=this.options.fov,this._originalWidth=e(this.element).find("canvas").width(),this._originalHeight=e(this.element).find("canvas").height(),e(this.element).addClass("Valiant360_default"),this.createMediaPlayer(),this.createControls()},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:7&i|8).toString(16)});return t},createMediaPlayer:function(){if(this._scene=new t.Scene,this._camera=new t.PerspectiveCamera(this._fov,e(this.element).width()/e(this.element).height(),.1,1e3),this._camera.setLens(this._fov),this._renderer=i.webgl?new t.WebGLRenderer:new t.CanvasRenderer,this._renderer.setSize(e(this.element).width(),e(this.element).height()),this._renderer.autoClear=!1,this._renderer.setClearColor(3355443,1),e(this.element).append(this._renderer.domElement),e(this.element).attr("data-photo-src"))this._isPhoto=!0,t.ImageUtils.crossOrigin=this.options.crossOrigin,this._texture=t.ImageUtils.loadTexture(e(this.element).attr("data-photo-src"));else{this._isVideo=!0,this._video=n.createElement("video"),this._video.setAttribute("crossorigin",this.options.crossOrigin),this._video.style.display="none",e(this.element).append(this._video),this._video.loop=this.options.loop,this._video.muted=this.options.muted,this._texture=new t.Texture(this._video);var s=this;this._video.addEventListener("ended",function(){}),this._video.addEventListener("progress",function(){var e=null;s._video&&s._video.buffered&&s._video.buffered.length>0&&s._video.buffered.end&&s._video.duration?e=s._video.buffered.end(0)/s._video.duration:s._video&&s._video.bytesTotal!==o&&s._video.bytesTotal>0&&s._video.bufferedBytes!==o&&(e=s._video.bufferedBytes/s._video.bytesTotal);Math.round(100*e)}),this._video.addEventListener("canplaythrough",function(){s.options.autoplay===!0&&(s._video.play(),s._videoReady=!0)}),this._video.src=e(this.element).attr("data-video-src")}this._texture.generateMipmaps=!1,this._texture.minFilter=t.LinearFilter,this._texture.magFilter=t.LinearFilter,this._texture.format=t.RGBFormat,this._mesh=new t.Mesh(new t.SphereGeometry(500,80,50),new t.MeshBasicMaterial({map:this._texture})),this._mesh.scale.x=-1,this._scene.add(this._mesh),this.animate()},createControls:function(){var t=this.options.muted?"fa-volume-off":"fa-volume-up",i=this.options.autoplay?"fa-pause":"fa-play",s='                 <div class="controls">                     <a href="#" class="playButton button fa '+i+'"></a>                     <a href="#" class="muteButton button fa '+t+'"></a>                     <a href="#" class="fullscreenButton button fa fa-expand"></a>                 </div>             ';e(this.element).append(s,!0),this.options.hideControls&&e(this.element).find(".controls").hide(),this.attachControlEvents()},attachControlEvents:function(){var t=this;this.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.element.addEventListener("touchmove",this.onMouseMove.bind(this),!1),t.options.disableZoom===!1&&(this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1)),this.element.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.element.addEventListener("touchstart",this.onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.element.addEventListener("touchend",this.onMouseUp.bind(this),!1),e(n).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",this.fullscreen.bind(this)),e(s).resize(function(){t.resizeGL(e(t.element).width(),e(t.element).height())}),e(this.element).find(".playButton").click(function(i){i.preventDefault(),e(this).hasClass("fa-pause")?(e(this).removeClass("fa-pause").addClass("fa-play"),t.pause()):(e(this).removeClass("fa-play").addClass("fa-pause"),t.play())}),e(this.element).find(".fullscreenButton").click(function(i){i.preventDefault();var s=e(t.element)[0];e(this).hasClass("fa-expand")?s.requestFullscreen?s.requestFullscreen():s.msRequestFullscreen?s.msRequestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen():s.requestFullscreen?n.exitFullscreen():s.msRequestFullscreen?n.msExitFullscreen():s.mozRequestFullScreen?n.mozCancelFullScreen():s.webkitRequestFullscreen&&n.webkitExitFullscreen()}),e(this.element).find(".muteButton").click(function(i){i.preventDefault(),e(this).hasClass("fa-volume-off")?(e(this).removeClass("fa-volume-off").addClass("fa-volume-up"),t._video.muted=!1):(e(this).removeClass("fa-volume-up").addClass("fa-volume-off"),t._video.muted=!0)})},onMouseMove:function(t){this._onPointerDownPointerX=t.clientX,this._onPointerDownPointerY=-t.clientY,this._onPointerDownLon=this._lon,this._onPointerDownLat=this._lat;var i,s;this.options.clickAndDrag?this._mouseDown&&(i=t.pageX-this._dragStart.x,s=t.pageY-this._dragStart.y,this._dragStart.x=t.pageX,this._dragStart.y=t.pageY,this._lon+=i,this._lat-=s):(i=.75*(t.pageX-e(this.element).find("canvas").offset().left),s=.8*(t.pageY-e(this.element).find("canvas").offset().top),this._lon=i/e(this.element).find("canvas").width()*430-225,this._lat=s/e(this.element).find("canvas").height()*-180+90)},onMouseWheel:function(e){var t=-.01;e.wheelDeltaY?this._fov-=e.wheelDeltaY*t:e.wheelDelta?this._fov-=e.wheelDelta*t:e.detail&&(this._fov+=1*e.detail),this._fov<this.options.fovMin?this._fov=this.options.fovMin:this._fov>this.options.fovMax&&(this._fov=this.options.fovMax),this._camera.setLens(this._fov),e.preventDefault()},onMouseDown:function(e){this._mouseDown=!0,this._dragStart.x=e.pageX,this._dragStart.y=e.pageY},onMouseUp:function(){this._mouseDown=!1},animate:function(){if(this._requestAnimationId=requestAnimationFrame(this.animate.bind(this)),this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA&&"undefined"!=typeof this._texture){var e=(new Date).getTime();e-this._time>=30&&(this._texture.needsUpdate=!0,this._time=e)}this.render()},render:function(){this._lat=Math.max(-85,Math.min(85,this._lat)),this._phi=(90-this._lat)*Math.PI/180,this._theta=this._lon*Math.PI/180;var e=500*Math.sin(this._phi)*Math.cos(this._theta),i=500*Math.cos(this._phi),s=500*Math.sin(this._phi)*Math.sin(this._theta);this._camera.lookAt(new t.Vector3(e,i,s)),this.options.flatProjection?(this._camera.position.x=0,this._camera.position.y=0,this._camera.position.z=0):(this._camera.position.x=-e,this._camera.position.y=-i,this._camera.position.z=-s),this._renderer.clear(),this._renderer.render(this._scene,this._camera)},play:function(){this._video.play()},pause:function(){this._video.pause()},loadVideo:function(e){this._video.src=e},unloadVideo:function(){this.pause(),this._video.src="",this._video.removeAttribute("src")},loadPhoto:function(e){this._texture=t.ImageUtils.loadTexture(e)},fullscreen:function(){!s.screenTop&&!s.screenY&&e(this.element).find("a.fa-expand").length>0?(this.resizeGL(screen.width,screen.height),e(this.element).addClass("fullscreen"),e(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),this._isFullscreen=!0):(this.resizeGL(this._originalWidth,this._originalHeight),e(this.element).removeClass("fullscreen"),e(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),this._isFullscreen=!1)},resizeGL:function(e,t){this._renderer.setSize(e,t),this._camera.aspect=e/t,this._camera.updateProjectionMatrix()},destroy:function(){s.cancelAnimationFrame(this._requestAnimationId),this._requestAnimationId="",this._texture.dispose(),this._scene.remove(this._mesh),this._isVideo&&this.unloadVideo(),e(this._renderer.domElement).remove()}},e.fn[r]=function(t){return this.each(function(){if("object"!=typeof t&&t){if(this.plugin[t])return this.plugin[t].apply(this.plugin,Array.prototype.slice.call(arguments,1))}else this.plugin=new a(this,t),e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,this.plugin)})}}(jQuery,THREE,Detector,window,document);